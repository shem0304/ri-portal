<?php
require_once __DIR__ . '/compat.php';
// index.php (PHP ë²„ì „)
// - data/institutes.json / data/reports.json ì„ ì½ì–´ í”„ë¡ íŠ¸ì— ì£¼ì…
// - ê¸°ë³¸ ë³´ê³ ì„œ ë°ì´í„°ëŠ” data/allreports_normalized.json
header('Content-Type: text/html; charset=utf-8');
$dataDir = __DIR__ . '/data';
$institutesFile = $dataDir . '/institutes.json';
$reportsFile = $dataDir . '/reports.json';
$defaultReportsFile = $dataDir . '/allreports_normalized.json';

function read_json_file($path, $fallback = array()) {
  if (!file_exists($path)) return $fallback;
  $raw = file_get_contents($path);
  if ($raw === false) return $fallback;
  $json = json_decode($raw, true);
  return is_array($json) ? $json : $fallback;
}

$institutes = read_json_file($institutesFile, array());
$reports = read_json_file($reportsFile, null);
if ($reports === null) $reports = read_json_file($defaultReportsFile, array());

// ìµœì‹  ì •ë¶€ ë³´ë„ìë£Œ(ì •ì±…ë¸Œë¦¬í•‘) 5ê±´ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
// - ëª¨ë°”ì¼ ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€(HTML)ì—ì„œ ì œëª©/ì¼ì/ë¶€ì²˜ëª…ì„ íŒŒì‹±
// - ê³¼ë„í•œ ì™¸ë¶€ í˜¸ì¶œì„ í”¼í•˜ê¸° ìœ„í•´ ì§§ì€ ìºì‹œ(TTL)ë¥¼ ì‚¬ìš©
function http_get_text($url, $timeoutSeconds = 6) {
  // ê³µìš© User-Agent/í—¤ë” (korea.kr ì¸¡ì—ì„œ ë¹„-ë¸Œë¼ìš°ì € UAë¥¼ 400ìœ¼ë¡œ ëŒë ¤ì£¼ëŠ” ê²½ìš°ê°€ ìˆì–´ ë¸Œë¼ìš°ì € UA ì‚¬ìš©)
  $ua = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0 Safari/537.36';
  $headers = "User-Agent: {$ua}\r\n" .
             "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\r\n" .
             "Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7\r\n" .
             "Connection: close\r\n";

  // 1) allow_url_fopen ì‚¬ìš© ê°€ëŠ¥í•˜ë©´ file_get_contents ìš°ì„ 
  $ctx = stream_context_create(array(
    'http' => array(
      'timeout' => $timeoutSeconds,
      'header' => $headers,
      'ignore_errors' => true
    ),
    'ssl' => array(
      'verify_peer' => true,
      'verify_peer_name' => true
    )
  ));

  $body = @file_get_contents($url, false, $ctx);
  if (is_string($body) && strlen($body) > 0) return $body;

  // 2) cURL
  if (!function_exists('curl_init')) return null;

  $try = function($verifyPeer) use ($url, $timeoutSeconds, $ua) {
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeoutSeconds);
    curl_setopt($ch, CURLOPT_TIMEOUT, $timeoutSeconds);
    curl_setopt($ch, CURLOPT_USERAGENT, $ua);
    curl_setopt($ch, CURLOPT_ENCODING, ''); // gzip/deflate ìë™ ì²˜ë¦¬
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
      'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
      'Accept-Language: ko-KR,ko;q=0.9,en-US;q=0.8,en;q=0.7',
      'Cache-Control: no-cache',
      'Pragma: no-cache'
    ));
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, $verifyPeer);
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, $verifyPeer ? 2 : 0);
    $out = curl_exec($ch);
    $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $err  = curl_errno($ch);
    curl_close($ch);

    // 200ì´ ì•„ë‹ˆì–´ë„ ë³¸ë¬¸ì´ ìˆìœ¼ë©´(ì¼ë¶€ ì„œë²„ 400 + body ë“±) ì¼ë‹¨ ë°˜í™˜
    if (is_string($out) && strlen($out) > 0 && ($code >= 200 && $code < 500)) return $out;

    // SSL ë¬¸ì œë¡œ ì‹¤íŒ¨í•œ ê²½ìš° ì¬ì‹œë„ ìœ ë„
    if ($err && !$verifyPeer) return null;
    return null;
  };

  $out = $try(true);
  if (is_string($out) && strlen($out) > 0) return $out;

  // 3) SSL ì¸ì¦ì„œ ì²´ì¸ ë¬¸ì œë¡œ ì‹¤íŒ¨í•˜ëŠ” í™˜ê²½ ëŒ€ì‘ (ìµœí›„ì˜ ìˆ˜ë‹¨)
  $out = $try(false);
  if (is_string($out) && strlen($out) > 0) return $out;

  return null;
}

function normalize_korea_date($dateStr) {
  // ì…ë ¥: 2025.1.7 ë˜ëŠ” 2025.01.07 â†’ ì¶œë ¥: 2025.01.07
  $parts = explode('.', trim($dateStr));
  if (count($parts) < 3) return trim($dateStr);
  $y = $parts[0];
  $m = str_pad(preg_replace('/\D/', '', $parts[1]), 2, '0', STR_PAD_LEFT);
  $d = str_pad(preg_replace('/\D/', '', $parts[2]), 2, '0', STR_PAD_LEFT);
  return $y . '.' . $m . '.' . $d;
}


function parse_pressrelease_html($html, $limit = 5, $baseUrl = 'https://m.korea.kr') {
  $items = array();
  if (!is_string($html) || $html === '') return $items;

  // ë³´ë„ìë£Œ ë§í¬(pressRelease* + newsId=)ë¥¼ ë¨¼ì € ì°¾ê³ , ì£¼ë³€ ë¸”ë¡(<li> ë˜ëŠ” <tr>)ì—ì„œ ë‚ ì§œ/ë¶€ì²˜ëª…ì„ ë³´ê°• ì¶”ì¶œ
  $re = '/<a\b[^>]*href=["\']([^"\']*(?:pressRelease|pressrelease)[^"\']*newsId=\d+[^"\']*)["\'][^>]*>(.*?)<\/a>/isu';

  if (!preg_match_all($re, $html, $ms, PREG_SET_ORDER | PREG_OFFSET_CAPTURE)) {
    return $items;
  }

  foreach ($ms as $m) {
    $href = trim($m[1][0]);
    $aHtml = $m[2][0];
    $offset = $m[0][1];

    $title = trim(preg_replace('/\s+/u', ' ', strip_tags(html_entity_decode($aHtml, ENT_QUOTES | ENT_HTML5, 'UTF-8'))));
    if ($href === '' || $title === '') continue;

    // ì£¼ë³€ ë¸”ë¡ ì¶”ì¶œ: <li> ... </li> ìš°ì„ , ì—†ìœ¼ë©´ <tr> ... </tr>, ê·¸ë˜ë„ ì—†ìœ¼ë©´ ì£¼ë³€ 1200byte
    $block = '';
    $before = substr($html, 0, $offset);
    $liStart = strripos($before, '<li');
    $liEnd = stripos($html, '</li>', $offset);
    if ($liStart !== false && $liEnd !== false && $liEnd > $offset) {
      $block = substr($html, $liStart, ($liEnd - $liStart) + 5);
    } else {
      $trStart = strripos($before, '<tr');
      $trEnd = stripos($html, '</tr>', $offset);
      if ($trStart !== false && $trEnd !== false && $trEnd > $offset) {
        $block = substr($html, $trStart, ($trEnd - $trStart) + 5);
      } else {
        $start = max(0, $offset - 400);
        $block = substr($html, $start, 1200);
      }
    }

    $blockText = trim(preg_replace('/\s+/u', ' ', strip_tags(html_entity_decode($block, ENT_QUOTES | ENT_HTML5, 'UTF-8'))));

    // ë‚ ì§œ/ë¶€ì²˜ëª… ì¶”ì¶œ: ".... 2026.01.07 ì‚°ë¦¼ì²­" í˜•íƒœ ë˜ëŠ” "2026.01.07ì‚°ë¦¼ì²­" í˜•íƒœ ëŒ€ì‘
    $date = '';
    $dept = '';

    if (preg_match('/(\d{4}\.\d{1,2}\.\d{1,2})/u', $blockText, $dm)) {
      $date = normalize_korea_date($dm[1]);

      // ë‚ ì§œ ë’¤ìª½ì—ì„œ ë¶€ì²˜ëª… í›„ë³´: ë‚ ì§œ ë‹¤ìŒ í† í°(ê³µë°± ìœ ë¬´ ë¬´ê´€)
      if (preg_match('/' . preg_quote($dm[1], '/') . '\s*([^\s\|\Â·\â€¢\(\)\[\]]{2,})/u', $blockText, $mm)) {
        $dept = trim($mm[1]);
      } else if (preg_match('/' . preg_quote($dm[1], '/') . '([^\s]{2,})/u', $blockText, $mm2)) {
        $dept = trim($mm2[1]);
      }
    }

    // ë‚ ì§œê°€ ì—†ìœ¼ë©´ í•´ë‹¹ í•­ëª© ìŠ¤í‚µ (ìš”êµ¬ì‚¬í•­: ì¼ì í‘œì‹œ)
    if ($date === '') continue;

    // ì ˆëŒ€ URLë¡œ ë³€í™˜
    if (!preg_match('/^https?:\/\//i', $href)) {
      $baseHost = $baseUrl;
      if (strpos($href, '/') === 0) $href = $baseHost . $href;
      else $href = rtrim($baseHost, '/') . '/briefing/' . $href;
    }

    $items[] = array('date' => $date, 'title' => $title, 'dept' => $dept, 'url' => $href);
    if (count($items) >= $limit) break;
  }

  return $items;
}

function parse_pressrelease_rss($xml, $limit = 5) {
($xml, $limit = 5) {
  $items = array();
  if (!is_string($xml) || $xml === '') return $items;

  // item ë¸”ë¡ ë‹¨ìœ„ë¡œ íŒŒì‹± (SimpleXML ì—†ì´)
  if (!preg_match_all('/<item\b[^>]*>(.*?)<\/item>/isu', $xml, $ms)) return $items;

  foreach ($ms[1] as $block) {
    $title = '';
    $link  = '';
    $dept  = '';
    $date  = '';

    if (preg_match('/<title\b[^>]*>(.*?)<\/title>/isu', $block, $m)) {
      $title = trim(strip_tags(html_entity_decode($m[1], ENT_QUOTES | ENT_HTML5, 'UTF-8')));
    }
    if (preg_match('/<link\b[^>]*>(.*?)<\/link>/isu', $block, $m)) {
      $link = trim(strip_tags($m[1]));
    } elseif (preg_match('/<guid\b[^>]*>(.*?)<\/guid>/isu', $block, $m)) {
      $link = trim(strip_tags($m[1]));
    }
    if (preg_match('/<pubDate\b[^>]*>(.*?)<\/pubDate>/isu', $block, $m)) {
      $ts = strtotime(trim(strip_tags($m[1])));
      if ($ts) $date = date('Y.m.d', $ts);
    } elseif (preg_match('/<dc:date\b[^>]*>(.*?)<\/dc:date>/isu', $block, $m)) {
      $ts = strtotime(trim(strip_tags($m[1])));
      if ($ts) $date = date('Y.m.d', $ts);
    }

    // ë¶€ì²˜ëª…ì€ category ë˜ëŠ” dc:creatorì— ìˆëŠ” ê²½ìš°ê°€ ë§ì•„ ìš°ì„ ìˆœìœ„ë¡œ íƒìƒ‰
    if (preg_match_all('/<category\b[^>]*>(.*?)<\/category>/isu', $block, $cats) && !empty($cats[1])) {
      // ì—¬ëŸ¬ ê°œë©´ ë§ˆì§€ë§‰ ê°’ì„ ìš°ì„  ì‚¬ìš©
      $dept = trim(strip_tags(html_entity_decode(end($cats[1]), ENT_QUOTES | ENT_HTML5, 'UTF-8')));
    }
    if ($dept === '' && preg_match('/<dc:creator\b[^>]*>(.*?)<\/dc:creator>/isu', $block, $m)) {
      $dept = trim(strip_tags(html_entity_decode($m[1], ENT_QUOTES | ENT_HTML5, 'UTF-8')));
    }

    if ($title === '' || $link === '') continue;
    if ($date === '') $date = '';

    $items[] = array('date' => $date, 'title' => $title, 'dept' => $dept, 'url' => $link);
    if (count($items) >= $limit) break;
  }
  return $items;
}

function fetch_latest_gov_pressreleases($limit = 5) {
  $cacheFile = __DIR__ . '/data/cache_gov_pressreleases.json';
  $ttl = 600; // 10ë¶„

  // ìºì‹œ ì‚¬ìš© (ê°€ëŠ¥í•˜ë©´)
  if (file_exists($cacheFile) && (time() - filemtime($cacheFile) < $ttl)) {
    $raw = @file_get_contents($cacheFile);
    $data = $raw ? json_decode($raw, true) : null;
    if (is_array($data)) return array_slice($data, 0, $limit);
  }

  $items = array();

  // 1) ëª¨ë°”ì¼ ë³´ë„ìë£Œ ëª©ë¡ (í˜„ì¬ UIì™€ ê°€ì¥ ì˜ ë§ìŒ)
  $html = http_get_text('https://m.korea.kr/briefing/pressReleaseDetailList.do', 8);
  $items = parse_pressrelease_html($html, $limit, 'https://m.korea.kr');

  // 2) PC ë³´ë„ìë£Œ ëª©ë¡(ëŒ€ì²´ ê²½ë¡œ)
  if (empty($items)) {
    $html2 = http_get_text('https://korea.kr/briefing/pressReleaseList.do', 8);
    // PC í˜ì´ì§€ë„ ë™ì¼í•œ ë§í¬/í…ìŠ¤íŠ¸ íŒ¨í„´ì´ ë§ì•„ ê°™ì€ íŒŒì„œ ì¬ì‚¬ìš©
    $items = parse_pressrelease_html($html2, $limit, 'https://www.korea.kr');
  }

  // 3) RSS (ìµœí›„ ëŒ€ì²´, ì¼ë¶€ í™˜ê²½ì—ì„œ HTML ì°¨ë‹¨ ì‹œ)
  if (empty($items)) {
    $rss = http_get_text('https://www.korea.kr/rss/pressrelease.xml', 8);
    $items = parse_pressrelease_rss($rss, $limit);
  }

  
  // ë””ë²„ê·¸: ë§ˆì§€ë§‰ ì™¸ë¶€ ìš”ì²­ ìƒíƒœë¥¼ íŒŒì¼ë¡œ ë‚¨ê¹€(ì“°ê¸° ê¶Œí•œ ì—†ìœ¼ë©´ ë¬´ì‹œ)
  global $__GOV_FETCH_DEBUG;
  if (is_array($__GOV_FETCH_DEBUG) && !empty($__GOV_FETCH_DEBUG)) {
    @file_put_contents(__DIR__ . '/data/last_gov_fetch_debug.json', json_encode($__GOV_FETCH_DEBUG, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT));
  }

// ë„¤íŠ¸ì›Œí¬ ì‹¤íŒ¨ ì‹œ: ì˜¤ë˜ëœ ìºì‹œë¼ë„ ìˆìœ¼ë©´ ì‚¬ìš©
  if (empty($items) && file_exists($cacheFile)) {
    $raw = @file_get_contents($cacheFile);
    $data = $raw ? json_decode($raw, true) : null;
    if (is_array($data)) return array_slice($data, 0, $limit);
  }

  // ìºì‹œ ì €ì¥ (ì“°ê¸° ê¶Œí•œ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ)
  if (!empty($items)) {
    @file_put_contents($cacheFile, json_encode($items, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES));
  }

  return $items;
}

$govPress = fetch_latest_gov_pressreleases(5);

$boot = array(
  'institutes' => $institutes,
  'reportsCount' => is_array($reports) ? count($reports) : 0,
  'api' => array(
    'reports' => './api/reports.php',
    'reportsSave' => './api/reports_save.php',
    'institutes' => './api/institutes.php',
    'downloadZip' => './download.php'
  )
);
?>
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì§€ì—­ì—°êµ¬ì› í†µí•© í¬í„¸</title>
  <link rel="stylesheet" href="./assets/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true">R</div>
      <div>
        <h1>ì§€ì—­ì—°êµ¬ì› í†µí•© í¬í„¸</h1>
        <p class="sub">ê¸°ê´€ ë°”ë¡œê°€ê¸° Â· ì—°êµ¬ë³´ê³ ì„œ ëª©ë¡</p>
      </div>
    </div>

    <div class="top-actions">
      <button id="themeToggle" class="btn ghost" type="button" aria-label="í…Œë§ˆ ì „í™˜">ğŸŒ—</button>
      <a class="btn ghost" href="./trends.php" id="trendBtn" title="ì—°êµ¬ ì œëª© ê¸°ë°˜ íŠ¸ë Œë“œ ë¶„ì„">ğŸ“ˆ ì—°êµ¬ íŠ¸ë Œë“œ</a>
      <a class="btn" href="#" id="exportBtn">ë‚´ë³´ë‚´ê¸°</a>
    </div>
  </header>

  <main class="container">
    <section class="tabs card">
      <button class="tab active" type="button" id="tabInstitutes" aria-controls="institutesView" aria-selected="true">ê¸°ê´€ ë°”ë¡œê°€ê¸°</button>
      <button class="tab" type="button" id="tabReports" aria-controls="reportsView" aria-selected="false">ì—°êµ¬ë³´ê³ ì„œ</button>
      <span class="tab-spacer"></span>
      <button class="btn ghost small" type="button" id="syncReportsBtn">ìë™ ìˆ˜ì§‘</button>
      <button class="btn ghost small" type="button" id="importReportsBtn">CSV/JSON ê°€ì ¸ì˜¤ê¸°</button>
    </section>

    <!-- ê¸°ê´€ ë°”ë¡œê°€ê¸° ë·° -->
    <section id="institutesView">
      <section class="controls card">
        <div class="row">
          <div class="field grow">
            <label for="q">ê²€ìƒ‰</label>
            <input id="q" type="search" placeholder="ì˜ˆ: ê²½ê¸°, ì „ë‚¨, ì—°êµ¬ì› ì´ë¦„â€¦" autocomplete="off" />
          </div>

          <div class="field">
            <label for="region">ì§€ì—­</label>
            <select id="region">
              <option value="ALL">ì „ì²´</option>
            </select>
          </div>

          <div class="field">
            <label for="viewMode">ë³´ê¸°</label>
            <select id="viewMode">
              <option value="ALL">ì „ì²´</option>
              <option value="FAV">ì¦ê²¨ì°¾ê¸°</option>
            </select>
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button id="resetBtn" class="btn ghost" type="button">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div class="chips" id="chips" aria-label="ë¹ ë¥¸ í•„í„°"></div>
        <div class="hint" id="hint"></div>
      </section>

      <section class="split">
        <section class="card">
          <div class="card-head">
            <h2>ëª©ë¡</h2>
            <span class="meta" id="countMeta"></span>
          </div>
          <div id="grid" class="grid" aria-live="polite"></div>
        </section>

        <aside class="card side">
          <div class="card-head">
            <h2>ìµœì‹  ì •ë¶€ ë³´ë„ìë£Œ</h2>
            <a class="btn ghost small" href="https://m.korea.kr/briefing/pressReleaseDetailList.do" target="_blank" rel="noopener noreferrer">ë”ë³´ê¸°</a>
          </div>
          <div id="govPress" class="recent" aria-label="ìµœì‹  ì •ë¶€ ë³´ë„ìë£Œ 5ê±´">
            <?php if (empty($govPress)) : ?>
              <div class="hint">ì •ë¶€ ë³´ë„ìë£Œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. <a href="https://m.korea.kr/briefing/pressReleaseDetailList.do" target="_blank" rel="noopener noreferrer">ì •ì±…ë¸Œë¦¬í•‘ì—ì„œ í™•ì¸</a></div>
              <?php if (isset($_GET['debug_gov'])) : ?>
                <pre class="gov-debug"><?php echo htmlspecialchars(@file_get_contents(__DIR__ . '/data/last_gov_fetch_debug.json') ?: json_encode($__GOV_FETCH_DEBUG, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT), ENT_QUOTES, 'UTF-8'); ?></pre>
              <?php endif; ?>
            <?php else : ?>
              <?php foreach ($govPress as $it) : ?>
                <a href="<?php echo htmlspecialchars($it['url'], ENT_QUOTES, 'UTF-8'); ?>" target="_blank" rel="noopener noreferrer">
                  <span>
                    <?php echo htmlspecialchars($it['title'], ENT_QUOTES, 'UTF-8'); ?>
                    <br />
                    <small><?php echo htmlspecialchars($it['date'], ENT_QUOTES, 'UTF-8'); ?></small>
                  </span>
                  <span class="badge"><?php echo htmlspecialchars($it['dept'], ENT_QUOTES, 'UTF-8'); ?></span>
                </a>
              <?php endforeach; ?>
            <?php endif; ?>
          </div>

          <hr class="sep" />

          <div class="card-head">
            <h2>ì¦ê²¨ì°¾ê¸°</h2>
            <button id="clearFavBtn" class="btn ghost small" type="button">ì „ì²´ í•´ì œ</button>
          </div>
          <div id="favList" class="recent"></div>

          <hr class="sep" />
          <details class="notes">
            <summary>ë©”ëª¨</summary>
            <ul>
              <li>â€œì—´ê¸°â€ëŠ” ìƒˆ íƒ­ìœ¼ë¡œ ì‚¬ì´íŠ¸ë¥¼ ì—½ë‹ˆë‹¤.</li>
              <li>ë³„(â˜…)ì„ ëˆ„ë¥´ë©´ ì¦ê²¨ì°¾ê¸°ì— ì €ì¥ë©ë‹ˆë‹¤(ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥).</li>
              <li>ì¸ì²œì—°êµ¬ì› ë§í¬ëŠ” ì œê³µëœ URLì´ ì¼ë¶€ ì˜ë ¤ ìˆì–´ ê¸°ë³¸ ë„ë©”ì¸ìœ¼ë¡œ ì—°ê²°ë˜ë„ë¡ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.</li>
              <li>ì—°êµ¬ë³´ê³ ì„œ íƒ­ì—ì„œ ë³´ê³ ì„œ CSV/JSONì„ ê°€ì ¸ì™€ ëª©ë¡ì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
            </ul>
          </details>
        </aside>
      </section>
    </section>

    <!-- ì—°êµ¬ë³´ê³ ì„œ ë·° -->
    <section id="reportsView" class="hidden">
      <section class="controls card">
        <div class="row">
          <div class="field grow">
            <label for="rq">ê²€ìƒ‰</label>
            <input id="rq" type="search" placeholder="ì œëª©/ì—°êµ¬ì/ê¸°ê´€ ê²€ìƒ‰â€¦" autocomplete="off" />
          </div>

          <div class="field">
            <label for="rInstitute">ê¸°ê´€</label>
            <select id="rInstitute">
              <option value="ALL">ì „ì²´</option>
            </select>
          </div>

          <div class="field">
            <label for="rYear">ìƒì‚°ë…„ë„</label>
            <select id="rYear">
              <option value="ALL">ì „ì²´</option>
            </select>
          </div>

          <div class="field">
            <label for="rSort">ì •ë ¬</label>
            <select id="rSort">
              <option value="YEAR_DESC">ì—°ë„â†“</option>
              <option value="YEAR_ASC">ì—°ë„â†‘</option>
              <option value="TITLE_ASC">ì œëª©â†‘</option>
              <option value="INSTITUTE_ASC">ê¸°ê´€â†‘</option>
            </select>
          </div>

          <div class="field">
            <label>&nbsp;</label>
            <button id="rResetBtn" class="btn ghost" type="button">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div class="hint" id="rHint"></div>
      </section>

      <section class="card">
        <div class="card-head">
          <h2>ì—°êµ¬ë³´ê³ ì„œ ëª©ë¡</h2>
          <div class="inline-actions">
            <span class="meta" id="syncMeta" title="ìë™ ìˆ˜ì§‘ ìƒíƒœ"></span>
            <button id="addSampleBtn" class="btn ghost small" type="button">ìƒ˜í”Œ ì¶”ê°€</button>
            <button id="clearReportsBtn" class="btn ghost small" type="button">ëª©ë¡ ë¹„ìš°ê¸°</button>
          </div>
        </div>

        <div class="table-wrap">
          <table class="table" aria-label="ì—°êµ¬ë³´ê³ ì„œ ëª©ë¡ í…Œì´ë¸”">
            <thead>
              <tr>
                <th style="width:110px;">ìƒì‚°ë…„ë„</th>
                <th>ì—°êµ¬ì œëª©</th>
                <th style="width:220px;">ì—°êµ¬ì</th>
                <th style="width:160px;">ê¸°ê´€</th>
                <th style="width:120px;">ë§í¬</th>
              </tr>
            </thead>
            <tbody id="reportsTbody"></tbody>
          </table>
        </div>

        <div class="empty" id="reportsEmpty"></div>
        <div class="pager" id="pager"></div>
      </section>
    </section>
  </main>

  <footer class="footer">
    <span>Â© í†µí•© í¬í„¸ (ì •ì  ì›¹ì•±)</span>
  </footer>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Import dialog -->
  <dialog id="importDialog" class="dialog">
    <form method="dialog" class="dialog-inner">
      <div class="dialog-head">
        <h3>ì—°êµ¬ë³´ê³ ì„œ ê°€ì ¸ì˜¤ê¸°</h3>
        <button class="btn ghost small" value="cancel" type="submit">ë‹«ê¸°</button>
      </div>

      <p class="dialog-desc">
        ì•„ë˜ì— <b>CSV</b> ë˜ëŠ” <b>JSON ë°°ì—´</b>ì„ ë¶™ì—¬ ë„£ìœ¼ë©´ ë¸Œë¼ìš°ì €ì— ì €ì¥ë©ë‹ˆë‹¤(ë¡œì»¬ ì €ì¥).
        CSV ì»¬ëŸ¼: <code>year,title,authors,institute,url</code>
      </p>

      <textarea id="importText" class="textarea" spellcheck="false"></textarea>

      <div class="dialog-actions">
        <button id="useTemplateBtn" class="btn ghost" type="button">í…œí”Œë¦¿ ë„£ê¸°</button>
        <button id="importApplyBtn" class="btn" type="button">ê°€ì ¸ì˜¤ê¸°</button>
      </div>

      <details class="notes">
        <summary>ì˜ˆì‹œ JSON</summary>
        <pre class="pre"><code>[
  {"year":2025,"title":"ì§€ì—­ê²½ì œ ë™í–¥ ë¶„ì„","authors":"í™ê¸¸ë™; ê¹€ì² ìˆ˜","institute":"ê²½ê¸°ì—°êµ¬ì›","url":"https://..."},
  {"year":2024,"title":"ë„ì‹œì •ì±… í‰ê°€","authors":"ì´ì˜í¬","institute":"ì„œìš¸ì—°êµ¬ì›"}
]</code></pre>
      </details>
    </form>
  </dialog>
  <script>
    // ì„œë²„ì—ì„œ ì£¼ì…ëœ ì´ˆê¸° ë°ì´í„°/ì—”ë“œí¬ì¸íŠ¸ (app.jsë³´ë‹¤ ë¨¼ì € ì •ì˜ë˜ì–´ì•¼ í•¨)
    window.__PORTAL_BOOT__ = <?php echo ri_json_encode($boot); ?>;
  </script>
  <script src="./assets/app.js"></script>
</body>
</html>